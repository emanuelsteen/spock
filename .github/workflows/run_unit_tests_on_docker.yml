name: Build PostgreSQL from Source with Version-Specific Patches

on:
  schedule:
    - cron: '0 12,0 * * *'
  push:
    branches:
      gh_actions  
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_version: ["14.15", "15.10", "16.6", "17.2"] 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - name: Build PostgreSQL ${{ matrix.pg_version }}
        run: docker build --build-arg PG_VERSION=${{ matrix.pg_version }} -t custom-postgres:${{ matrix.pg_version }} .

      - name: Run PostgreSQL Version Check for ${{ matrix.pg_version }}
        run: docker run --rm custom-postgres:${{ matrix.pg_version }} postgres --version

      - name: Wait for PostgreSQL to be ready
        run: |
          echo "Waiting for PostgreSQL to be ready..."
            for i in {1..30}; do
              if pg_isready -h localhost -p 5432 -U postgres; then
                echo "PostgreSQL is ready!"
                  exit 0
              fi
              echo "PostgreSQL is not ready yet. Retrying in 5 seconds..."
              sleep 5
              done
              echo "PostgreSQL did not become ready in time. Exiting."
              exit 1
